jQuery(document).ready(function(e){"use strict";var i={isProcessing:!1,progressInterval:null,currentBatch:0,totalBatches:0};function s(i){var s=e("#mpbig-generate"),a=e("#mpbig-spinner"),t=e("#mpbig-progress"),r=e("#mpbig-results"),o=e("#mpbig-results-content"),n=e("#mpbig-form");o.html('<div class="mpbig-notice mpbig-notice-error"><p>'+i+"</p></div>"),r.slideDown(400).addClass("mpbig-fade-in"),s.prop("disabled",!1).removeClass("mpbig-loading"),a.hide(),t.hide(),n.removeClass("mpbig-loading")}function a(){var r=e("#mpbig-generate"),o=e("#mpbig-spinner"),n=(e("#mpbig-progress-text"),e("#mpbig-results")),p=e("#mpbig-results-content"),c=e("#mpbig-progress-container"),g=e("#mpbig-form"),m=new FormData;m.append("action","mpbig_process_batch"),m.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:m,processData:!1,contentType:!1,success:function(m){if(m.success)if(i.currentBatch++,m.complete){i.isProcessing=!1,t();var l='<div class="mpbig-notice mpbig-notice-success"><p>'+m.message+"</p></div>";m.errors&&m.errors.length>0&&(l+='<div class="mpbig-notice mpbig-notice-warning"><p><strong>Errors:</strong></p><ul>',m.errors.forEach(function(e){l+="<li>"+e+"</li>"}),l+="</ul></div>"),p.html(l),n.slideDown(400).addClass("mpbig-fade-in"),r.prop("disabled",!1).removeClass("mpbig-loading"),o.hide(),e("#mpbig-progress").hide(),c.slideUp(400),g.removeClass("mpbig-loading"),m.create_zip&&function(){var i=e("#mpbig-results-content"),s=e("#mpbig-progress-text"),a=e("#mpbig-progress"),t=e("#mpbig-spinner");s.text(mpbig_ajax.creating_zip),a.show(),t.show();var r=new FormData;r.append("action","mpbig_create_zip"),r.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:r,processData:!1,contentType:!1,success:function(e){if(a.hide(),t.hide(),e.success){var s='<div class="mpbig-notice mpbig-notice-success"><p>'+e.message+"</p>";s+='<p><a href="'+e.zip_url+'" class="mpbig-download-btn" download="'+e.zip_filename+'">Download ZIP File</a></p></div>',i.append(s)}else s='<div class="mpbig-notice mpbig-notice-error"><p>'+e.message+"</p></div>",i.append(s)},error:function(e,s,r){a.hide(),t.hide();var o='<div class="mpbig-notice mpbig-notice-error"><p>'+mpbig_ajax.zip_error+": "+r+"</p></div>";i.append(o)}})}()}else setTimeout(a,100);else i.isProcessing=!1,t(),s(m.message)},error:function(e,a,r){i.isProcessing=!1,t(),s(mpbig_ajax.error+": "+r)}})}function t(){i.progressInterval&&(clearInterval(i.progressInterval),i.progressInterval=null)}function r(i,s){var a=s>0?Math.round(i/s*100):0;e("#mpbig-progress-fill").css("width",a+"%"),e("#mpbig-progress-current").text(i),e("#mpbig-progress-total").text(s),e("#mpbig-progress-percentage").text(a+"%")}e(".mpbig-datepicker").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearRange:"-10:+1",showAnim:"fadeIn",beforeShow:function(i,s){setTimeout(function(){e(".ui-datepicker").addClass("mpbig-datepicker-ui")},10)}}),e("#mpbig-type").on("change",function(){"period"===e(this).val()?e("#mpbig-period-options").slideDown(300).addClass("mpbig-fade-in"):e("#mpbig-period-options").slideUp(300)}),e("#mpbig-form").on("submit",function(t){if(t.preventDefault(),!i.isProcessing){var o=e(this),n=e("#mpbig-generate"),p=e("#mpbig-spinner"),c=e("#mpbig-progress"),g=e("#mpbig-progress-text"),m=e("#mpbig-results"),l=(e("#mpbig-results-content"),e("#mpbig-progress-container"));e(".mpbig-notice-error").remove();var d,b=function(){var i=[];if("period"===e("#mpbig-type").val()){var s=e("#mpbig-start-date").val(),a=e("#mpbig-end-date").val();s&&a?new Date(s)>=new Date(a)&&i.push("End date must be after start date."):i.push("Please select both start and end dates for period generation.")}return 0===e('input[name="status[]"]:checked').length&&i.push("Please select at least one transaction status."),i}();if(b.length>0)return d='<div class="mpbig-notice mpbig-notice-error"><p><strong>Please fix the following errors:</strong></p><ul>',b.forEach(function(e){d+="<li>"+e+"</li>"}),d+="</ul></div>",e(".mpbig-notice-error").remove(),e("#mpbig-form").prepend(d),void e("html, body").animate({scrollTop:e(".mpbig-notice-error").offset().top-100},500);n.prop("disabled",!0).addClass("mpbig-loading"),p.show(),c.show(),g.text(mpbig_ajax.generating),m.hide(),l.hide(),o.addClass("mpbig-loading");var u=new FormData(o[0]);u.append("action","mpbig_generate_invoices"),u.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:u,processData:!1,contentType:!1,success:function(t){t.success?(i.isProcessing=!0,i.totalBatches=Math.ceil(t.total/mpbig_ajax.batch_size),i.currentBatch=0,l.slideDown(400).addClass("mpbig-fade-in"),r(0,t.total),i.progressInterval=setInterval(function(){!function(){var i=new FormData;i.append("action","mpbig_get_progress"),i.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:i,processData:!1,contentType:!1,success:function(i){i.success&&(r(i.processed,i.total),function(i,s,a,t){var r="Processed: "+i+" / "+s+" transactions";a>0&&(r+=" | Successful: "+a),t&&t.length>0&&(r+=" | Errors: "+t.length),e("#mpbig-progress-status").text(r)}(i.processed,i.total,i.successful,i.errors))}})}()},2e3),a()):s(t.message)},error:function(e,i,a){s(mpbig_ajax.error+": "+a)}})}}),e(".mpbig-checkbox-item").on("click",function(){var i=e(this).find('input[type="checkbox"]');i.prop("checked",!i.prop("checked")),e(this).toggleClass("mpbig-checked",i.prop("checked"))});var o=(new Date).getFullYear();e("#mpbig-start-date").val(o+"-01-01"),e("#mpbig-end-date").val(o+"-12-31"),e(".mpbig-card").hover(function(){e(this).addClass("mpbig-hover")},function(){e(this).removeClass("mpbig-hover")}),e(".mpbig-form-control:not(.mpbig-select)").on("focus",function(){e(this).closest(".mpbig-form-group").addClass("mpbig-focused")}).on("blur",function(){e(this).closest(".mpbig-form-group").removeClass("mpbig-focused")}),e("#mpbig-empty-folder").on("click",function(){if(confirm("Are you sure you want to delete all PDF files? This action cannot be undone.")){var i=e(this),s=e("#mpbig-empty-spinner");i.prop("disabled",!0).addClass("mpbig-loading"),s.show();var a=new FormData;a.append("action","mpbig_empty_folder"),a.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:a,processData:!1,contentType:!1,success:function(a){if(i.prop("disabled",!1).removeClass("mpbig-loading"),s.hide(),a.success){var t='<div class="mpbig-notice mpbig-notice-success"><p>'+a.message+"</p></div>";e(".mpbig-file-management").after(t),e(".mpbig-file-stat-number").first().text("0"),e(".mpbig-file-stat-number").last().text("0 B"),e("html, body").animate({scrollTop:e(".mpbig-notice-success").offset().top-100},500),setTimeout(function(){e(".mpbig-notice-success").fadeOut(300,function(){e(this).remove()})},5e3)}else t='<div class="mpbig-notice mpbig-notice-error"><p>'+a.message+"</p></div>",e(".mpbig-file-management").after(t),e("html, body").animate({scrollTop:e(".mpbig-notice-error").offset().top-100},500)},error:function(a,t,r){i.prop("disabled",!1).removeClass("mpbig-loading"),s.hide();var o='<div class="mpbig-notice mpbig-notice-error"><p>Error: '+r+"</p></div>";e(".mpbig-file-management").after(o)}})}}),e(window).on("load",function(){e(".mpbig-container").addClass("mpbig-loaded")})});