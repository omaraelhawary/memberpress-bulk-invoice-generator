jQuery(document).ready(function(e){"use strict";var i={isProcessing:!1,progressInterval:null,currentBatch:0,totalBatches:0};function s(s){var a=e("#mpfig-generate"),o=e("#mpfig-spinner"),t=e("#mpfig-progress"),p=e("#mpfig-results"),r=e("#mpfig-results-content"),f=e("#mpfig-form"),d=e("#mpfig-progress-container");i.isProcessing=!1,n(),r.html('<div class="mpfig-notice mpfig-notice-error"><p>'+s+"</p></div>"),p.removeClass("mpfig-hidden").addClass("mpfig-slide-down mpfig-fade-in"),p[0].offsetHeight,p.addClass("mpfig-visible"),a.prop("disabled",!1).removeClass("mpfig-loading"),o.addClass("mpfig-hidden"),t.addClass("mpfig-hidden"),d.addClass("mpfig-hidden"),f.removeClass("mpfig-loading")}function a(){var o=e("#mpfig-generate"),t=e("#mpfig-spinner"),p=(e("#mpfig-progress-text"),e("#mpfig-results")),r=e("#mpfig-results-content"),f=e("#mpfig-progress-container"),d=e("#mpfig-form"),m=new FormData;m.append("action","mpfig_process_batch"),m.append("nonce",mpfig_ajax.nonce),e.ajax({url:mpfig_ajax.ajax_url,type:"POST",data:m,processData:!1,contentType:!1,success:function(m){if(m.success)if(i.currentBatch++,m.complete){i.isProcessing=!1,n();var g='<div class="mpfig-notice mpfig-notice-success"><p>'+m.message+"</p></div>";m.errors&&m.errors.length>0&&(g+='<div class="mpfig-notice mpfig-notice-warning"><p><strong>Errors:</strong></p><ul>',m.errors.forEach(function(e){g+="<li>"+e+"</li>"}),g+="</ul></div>"),r.html(g),p.removeClass("mpfig-hidden").addClass("mpfig-slide-down mpfig-fade-in"),p[0].offsetHeight,p.addClass("mpfig-visible"),o.prop("disabled",!1).removeClass("mpfig-loading"),t.addClass("mpfig-hidden"),e("#mpfig-progress").addClass("mpfig-hidden"),f.removeClass("mpfig-visible").addClass("mpfig-slide-up"),setTimeout(function(){f.addClass("mpfig-hidden").removeClass("mpfig-slide-down mpfig-slide-up")},400),d.removeClass("mpfig-loading"),m.create_zip&&function(){var i=e("#mpfig-results-content"),s=e("#mpfig-progress-text"),a=e("#mpfig-progress"),n=e("#mpfig-spinner");s.text(mpfig_ajax.creating_zip),a.removeClass("mpfig-hidden"),n.removeClass("mpfig-hidden");var o=new FormData;o.append("action","mpfig_create_zip"),o.append("nonce",mpfig_ajax.nonce),e.ajax({url:mpfig_ajax.ajax_url,type:"POST",data:o,processData:!1,contentType:!1,success:function(e){if(a.addClass("mpfig-hidden"),n.addClass("mpfig-hidden"),e.success){var s='<div class="mpfig-notice mpfig-notice-success"><p>'+e.message+"</p>";s+='<p><a href="'+e.zip_url+'" class="mpfig-download-btn" download="'+e.zip_filename+'">Download ZIP File</a></p></div>',i.append(s)}else s='<div class="mpfig-notice mpfig-notice-error"><p>'+e.message+"</p></div>",i.append(s)},error:function(e,s,o){a.addClass("mpfig-hidden"),n.addClass("mpfig-hidden");var t='<div class="mpfig-notice mpfig-notice-error"><p>'+mpfig_ajax.zip_error+": "+o+"</p></div>";i.append(t)}})}()}else setTimeout(a,100);else i.isProcessing=!1,n(),s(m.message)},error:function(e,a,o){i.isProcessing=!1,n(),s(mpfig_ajax.error+": "+o)}})}function n(){i.progressInterval&&(clearInterval(i.progressInterval),i.progressInterval=null)}function o(i,s){var a=s>0?Math.round(i/s*100):0;e("#mpfig-progress-fill")[0].style.setProperty("--progress-width",a+"%"),e("#mpfig-progress-current").text(i),e("#mpfig-progress-total").text(s),e("#mpfig-progress-percentage").text(a+"%")}e(".mpfig-datepicker").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearRange:"-10:+1",showAnim:"fadeIn"}),e("#mpfig-type").on("change",function(){var i=e(this).val(),s=e("#mpfig-period-options");"period"===i?(s.removeClass("mpfig-hidden").addClass("mpfig-slide-down mpfig-visible mpfig-fade-in"),s[0].offsetHeight,s.addClass("mpfig-visible")):(s.removeClass("mpfig-visible").addClass("mpfig-slide-up"),setTimeout(function(){s.addClass("mpfig-hidden").removeClass("mpfig-slide-down mpfig-slide-up")},300))}),e("#mpfig-form").on("submit",function(t){if(t.preventDefault(),!i.isProcessing){var p=e(this),r=e("#mpfig-generate"),f=e("#mpfig-spinner"),d=e("#mpfig-progress"),m=e("#mpfig-progress-text"),g=e("#mpfig-results"),c=(e("#mpfig-results-content"),e("#mpfig-progress-container"));e(".mpfig-notice-error").remove();var l,u=function(){var i=[];if("period"===e("#mpfig-type").val()){var s=e("#mpfig-start-date").val(),a=e("#mpfig-end-date").val();s&&a?new Date(s)>=new Date(a)&&i.push("End date must be after start date."):i.push("Please select both start and end dates for period generation.")}0===e('input[name="status[]"]:checked').length&&i.push("Please select at least one transaction status.");var n=e("#mpfig-customer-email").val().trim();return n&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)&&i.push("Please enter a valid email address for the customer filter."),i}();if(u.length>0)return l='<div class="mpfig-notice mpfig-notice-error"><p><strong>Please fix the following errors:</strong></p><ul>',u.forEach(function(e){l+="<li>"+e+"</li>"}),l+="</ul></div>",e(".mpfig-notice-error").remove(),e("#mpfig-form").prepend(l),void e("html, body").animate({scrollTop:e(".mpfig-notice-error").offset().top-100},500);i.isProcessing=!1,n(),r.prop("disabled",!0).addClass("mpfig-loading"),f.removeClass("mpfig-hidden"),d.removeClass("mpfig-hidden"),m.text(mpfig_ajax.generating),g.addClass("mpfig-hidden"),c.addClass("mpfig-hidden"),p.addClass("mpfig-loading");var v=new FormData(p[0]);v.append("action","mpfig_generate_invoices"),v.append("nonce",mpfig_ajax.nonce),e.ajax({url:mpfig_ajax.ajax_url,type:"POST",data:v,processData:!1,contentType:!1,success:function(n){n.success?(i.isProcessing=!0,i.totalBatches=Math.ceil(n.total/mpfig_ajax.batch_size),i.currentBatch=0,c.removeClass("mpfig-hidden").addClass("mpfig-slide-down mpfig-fade-in"),c[0].offsetHeight,c.addClass("mpfig-visible"),o(0,n.total),i.progressInterval=setInterval(function(){!function(){var i=new FormData;i.append("action","mpfig_get_progress"),i.append("nonce",mpfig_ajax.nonce),e.ajax({url:mpfig_ajax.ajax_url,type:"POST",data:i,processData:!1,contentType:!1,success:function(i){i.success&&(o(i.processed,i.total),function(i,s,a,n){var o="Processed: "+i+" / "+s+" transactions";a>0&&(o+=" | Successful: "+a),n&&n.length>0&&(o+=" | Errors: "+n.length),e("#mpfig-progress-status").text(o)}(i.processed,i.total,i.successful,i.errors))}})}()},2e3),a()):s(n.message)},error:function(e,i,a){var n=mpfig_ajax.error+": "+a;if(e.responseJSON&&e.responseJSON.data&&e.responseJSON.data.message)n=e.responseJSON.data.message;else if(e.responseText)try{var o=JSON.parse(e.responseText);o.data&&o.data.message&&(n=o.data.message)}catch(e){}s(n)}})}}),e(".mpfig-checkbox-item").on("click",function(){var i=e(this).find('input[type="checkbox"]');i.prop("checked",!i.prop("checked")),e(this).toggleClass("mpfig-checked",i.prop("checked"))});var t=(new Date).getFullYear();e("#mpfig-start-date").val(t+"-01-01"),e("#mpfig-end-date").val(t+"-12-31"),e(".mpfig-card").hover(function(){e(this).addClass("mpfig-hover")},function(){e(this).removeClass("mpfig-hover")}),e(".mpfig-form-control:not(.mpfig-select)").on("focus",function(){e(this).closest(".mpfig-form-group").addClass("mpfig-focused")}).on("blur",function(){e(this).closest(".mpfig-form-group").removeClass("mpfig-focused")}),e("#mpfig-download-files").on("click",function(){var i=e(this),s=e("#mpfig-download-spinner");i.prop("disabled",!0).addClass("mpfig-loading"),s.removeClass("mpfig-hidden");var a=new FormData;a.append("action","mpfig_download_files"),a.append("nonce",mpfig_ajax.nonce),e.ajax({url:mpfig_ajax.ajax_url,type:"POST",data:a,processData:!1,contentType:!1,success:function(a){if(i.prop("disabled",!1).removeClass("mpfig-loading"),s.addClass("mpfig-hidden"),a.success){var n=document.createElement("a");n.href=a.zip_url,n.download=a.zip_filename,document.body.appendChild(n),n.click(),document.body.removeChild(n);var o='<div class="mpfig-notice mpfig-notice-success"><p>'+a.message+" ("+a.file_count+" files)</p></div>";e(".mpfig-file-management").after(o),e("html, body").animate({scrollTop:e(".mpfig-notice-success").offset().top-100},500),setTimeout(function(){e(".mpfig-notice-success").addClass("mpfig-fade-out mpfig-hidden"),setTimeout(function(){e(".mpfig-notice-success").remove()},300)},5e3)}else o='<div class="mpfig-notice mpfig-notice-error"><p>'+a.message+"</p></div>",e(".mpfig-file-management").after(o),e("html, body").animate({scrollTop:e(".mpfig-notice-error").offset().top-100},500)},error:function(a,n,o){i.prop("disabled",!1).removeClass("mpfig-loading"),s.addClass("mpfig-hidden");var t='<div class="mpfig-notice mpfig-notice-error"><p>Error: '+o+"</p></div>";e(".mpfig-file-management").after(t)}})}),e("#mpfig-empty-folder").on("click",function(){if(confirm("Are you sure you want to delete all PDF files? This action cannot be undone.")){var i=e(this),s=e("#mpfig-empty-spinner");i.prop("disabled",!0).addClass("mpfig-loading"),s.removeClass("mpfig-hidden");var a=new FormData;a.append("action","mpfig_empty_folder"),a.append("nonce",mpfig_ajax.nonce),e.ajax({url:mpfig_ajax.ajax_url,type:"POST",data:a,processData:!1,contentType:!1,success:function(a){if(i.prop("disabled",!1).removeClass("mpfig-loading"),s.addClass("mpfig-hidden"),a.success){var n='<div class="mpfig-notice mpfig-notice-success"><p>'+a.message+"</p></div>";e(".mpfig-file-management").after(n),e(".mpfig-file-stat-number").first().text("0"),e(".mpfig-file-stat-number").last().text("0 B"),e("html, body").animate({scrollTop:e(".mpfig-notice-success").offset().top-100},500),setTimeout(function(){e(".mpfig-notice-success").addClass("mpfig-fade-out mpfig-hidden"),setTimeout(function(){e(".mpfig-notice-success").remove()},300)},5e3)}else n='<div class="mpfig-notice mpfig-notice-error"><p>'+a.message+"</p></div>",e(".mpfig-file-management").after(n),e("html, body").animate({scrollTop:e(".mpfig-notice-error").offset().top-100},500)},error:function(a,n,o){i.prop("disabled",!1).removeClass("mpfig-loading"),s.addClass("mpfig-hidden");var t='<div class="mpfig-notice mpfig-notice-error"><p>Error: '+o+"</p></div>";e(".mpfig-file-management").after(t)}})}}),e(window).on("load",function(){e(".mpfig-container").addClass("mpfig-loaded")})});