jQuery(document).ready(function(e){"use strict";var i={isProcessing:!1,progressInterval:null,currentBatch:0,totalBatches:0};function s(i){var s=e("#mpbig-generate"),a=e("#mpbig-spinner"),t=e("#mpbig-progress"),o=e("#mpbig-results"),n=e("#mpbig-results-content"),r=e("#mpbig-form");n.html('<div class="mpbig-notice mpbig-notice-error"><p>'+i+"</p></div>"),o.slideDown(400).addClass("mpbig-fade-in"),s.prop("disabled",!1).removeClass("mpbig-loading"),a.hide(),t.hide(),r.removeClass("mpbig-loading")}function a(){var o=e("#mpbig-generate"),n=e("#mpbig-spinner"),r=(e("#mpbig-progress-text"),e("#mpbig-results")),p=e("#mpbig-results-content"),c=e("#mpbig-progress-container"),m=e("#mpbig-form"),g=new FormData;g.append("action","mpbig_process_batch"),g.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:g,processData:!1,contentType:!1,success:function(g){if(g.success)if(i.currentBatch++,g.complete){i.isProcessing=!1,t();var l='<div class="mpbig-notice mpbig-notice-success"><p>'+g.message+"</p></div>";g.errors&&g.errors.length>0&&(l+='<div class="mpbig-notice mpbig-notice-warning"><p><strong>Errors:</strong></p><ul>',g.errors.forEach(function(e){l+="<li>"+e+"</li>"}),l+="</ul></div>"),p.html(l),r.slideDown(400).addClass("mpbig-fade-in"),o.prop("disabled",!1).removeClass("mpbig-loading"),n.hide(),e("#mpbig-progress").hide(),c.slideUp(400),m.removeClass("mpbig-loading"),g.create_zip&&function(){var i=e("#mpbig-results-content"),s=e("#mpbig-progress-text"),a=e("#mpbig-progress"),t=e("#mpbig-spinner");s.text(mpbig_ajax.creating_zip),a.show(),t.show();var o=new FormData;o.append("action","mpbig_create_zip"),o.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:o,processData:!1,contentType:!1,success:function(e){if(a.hide(),t.hide(),e.success){var s='<div class="mpbig-notice mpbig-notice-success"><p>'+e.message+"</p>";s+='<p><a href="'+e.zip_url+'" class="mpbig-download-btn" download="'+e.zip_filename+'">Download ZIP File</a></p></div>',i.append(s)}else s='<div class="mpbig-notice mpbig-notice-error"><p>'+e.message+"</p></div>",i.append(s)},error:function(e,s,o){a.hide(),t.hide();var n='<div class="mpbig-notice mpbig-notice-error"><p>'+mpbig_ajax.zip_error+": "+o+"</p></div>";i.append(n)}})}()}else setTimeout(a,100);else i.isProcessing=!1,t(),s(g.message)},error:function(e,a,o){i.isProcessing=!1,t(),s(mpbig_ajax.error+": "+o)}})}function t(){i.progressInterval&&(clearInterval(i.progressInterval),i.progressInterval=null)}function o(i,s){var a=s>0?Math.round(i/s*100):0;e("#mpbig-progress-fill").css("width",a+"%"),e("#mpbig-progress-current").text(i),e("#mpbig-progress-total").text(s),e("#mpbig-progress-percentage").text(a+"%")}e(".mpbig-datepicker").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearRange:"-10:+1",showAnim:"fadeIn",beforeShow:function(i,s){setTimeout(function(){e(".ui-datepicker").addClass("mpbig-datepicker-ui")},10)}}),e("#mpbig-type").on("change",function(){"period"===e(this).val()?e("#mpbig-period-options").slideDown(300).addClass("mpbig-fade-in"):e("#mpbig-period-options").slideUp(300)}),e("#mpbig-form").on("submit",function(t){if(t.preventDefault(),!i.isProcessing){var n=e(this),r=e("#mpbig-generate"),p=e("#mpbig-spinner"),c=e("#mpbig-progress"),m=e("#mpbig-progress-text"),g=e("#mpbig-results"),l=(e("#mpbig-results-content"),e("#mpbig-progress-container"));e(".mpbig-notice-error").remove();var d,b=function(){var i=[];if("period"===e("#mpbig-type").val()){var s=e("#mpbig-start-date").val(),a=e("#mpbig-end-date").val();s&&a?new Date(s)>=new Date(a)&&i.push("End date must be after start date."):i.push("Please select both start and end dates for period generation.")}0===e('input[name="status[]"]:checked').length&&i.push("Please select at least one transaction status.");var t=e("#mpbig-customer-email").val().trim();return t&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)&&i.push("Please enter a valid email address for the customer filter."),i}();if(b.length>0)return d='<div class="mpbig-notice mpbig-notice-error"><p><strong>Please fix the following errors:</strong></p><ul>',b.forEach(function(e){d+="<li>"+e+"</li>"}),d+="</ul></div>",e(".mpbig-notice-error").remove(),e("#mpbig-form").prepend(d),void e("html, body").animate({scrollTop:e(".mpbig-notice-error").offset().top-100},500);r.prop("disabled",!0).addClass("mpbig-loading"),p.show(),c.show(),m.text(mpbig_ajax.generating),g.hide(),l.hide(),n.addClass("mpbig-loading");var u=new FormData(n[0]);u.append("action","mpbig_generate_invoices"),u.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:u,processData:!1,contentType:!1,success:function(t){t.success?(i.isProcessing=!0,i.totalBatches=Math.ceil(t.total/mpbig_ajax.batch_size),i.currentBatch=0,l.slideDown(400).addClass("mpbig-fade-in"),o(0,t.total),i.progressInterval=setInterval(function(){!function(){var i=new FormData;i.append("action","mpbig_get_progress"),i.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:i,processData:!1,contentType:!1,success:function(i){i.success&&(o(i.processed,i.total),function(i,s,a,t){var o="Processed: "+i+" / "+s+" transactions";a>0&&(o+=" | Successful: "+a),t&&t.length>0&&(o+=" | Errors: "+t.length),e("#mpbig-progress-status").text(o)}(i.processed,i.total,i.successful,i.errors))}})}()},2e3),a()):s(t.message)},error:function(e,i,a){s(mpbig_ajax.error+": "+a)}})}}),e(".mpbig-checkbox-item").on("click",function(){var i=e(this).find('input[type="checkbox"]');i.prop("checked",!i.prop("checked")),e(this).toggleClass("mpbig-checked",i.prop("checked"))});var n=(new Date).getFullYear();e("#mpbig-start-date").val(n+"-01-01"),e("#mpbig-end-date").val(n+"-12-31"),e(".mpbig-card").hover(function(){e(this).addClass("mpbig-hover")},function(){e(this).removeClass("mpbig-hover")}),e(".mpbig-form-control:not(.mpbig-select)").on("focus",function(){e(this).closest(".mpbig-form-group").addClass("mpbig-focused")}).on("blur",function(){e(this).closest(".mpbig-form-group").removeClass("mpbig-focused")}),e("#mpbig-download-files").on("click",function(){var i=e(this),s=e("#mpbig-download-spinner");i.prop("disabled",!0).addClass("mpbig-loading"),s.show();var a=new FormData;a.append("action","mpbig_download_files"),a.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:a,processData:!1,contentType:!1,success:function(a){if(i.prop("disabled",!1).removeClass("mpbig-loading"),s.hide(),a.success){var t=document.createElement("a");t.href=a.zip_url,t.download=a.zip_filename,document.body.appendChild(t),t.click(),document.body.removeChild(t);var o='<div class="mpbig-notice mpbig-notice-success"><p>'+a.message+" ("+a.file_count+" files)</p></div>";e(".mpbig-file-management").after(o),e("html, body").animate({scrollTop:e(".mpbig-notice-success").offset().top-100},500),setTimeout(function(){e(".mpbig-notice-success").fadeOut(300,function(){e(this).remove()})},5e3)}else o='<div class="mpbig-notice mpbig-notice-error"><p>'+a.message+"</p></div>",e(".mpbig-file-management").after(o),e("html, body").animate({scrollTop:e(".mpbig-notice-error").offset().top-100},500)},error:function(a,t,o){i.prop("disabled",!1).removeClass("mpbig-loading"),s.hide();var n='<div class="mpbig-notice mpbig-notice-error"><p>Error: '+o+"</p></div>";e(".mpbig-file-management").after(n)}})}),e("#mpbig-empty-folder").on("click",function(){if(confirm("Are you sure you want to delete all PDF files? This action cannot be undone.")){var i=e(this),s=e("#mpbig-empty-spinner");i.prop("disabled",!0).addClass("mpbig-loading"),s.show();var a=new FormData;a.append("action","mpbig_empty_folder"),a.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:a,processData:!1,contentType:!1,success:function(a){if(i.prop("disabled",!1).removeClass("mpbig-loading"),s.hide(),a.success){var t='<div class="mpbig-notice mpbig-notice-success"><p>'+a.message+"</p></div>";e(".mpbig-file-management").after(t),e(".mpbig-file-stat-number").first().text("0"),e(".mpbig-file-stat-number").last().text("0 B"),e("html, body").animate({scrollTop:e(".mpbig-notice-success").offset().top-100},500),setTimeout(function(){e(".mpbig-notice-success").fadeOut(300,function(){e(this).remove()})},5e3)}else t='<div class="mpbig-notice mpbig-notice-error"><p>'+a.message+"</p></div>",e(".mpbig-file-management").after(t),e("html, body").animate({scrollTop:e(".mpbig-notice-error").offset().top-100},500)},error:function(a,t,o){i.prop("disabled",!1).removeClass("mpbig-loading"),s.hide();var n='<div class="mpbig-notice mpbig-notice-error"><p>Error: '+o+"</p></div>";e(".mpbig-file-management").after(n)}})}}),e(window).on("load",function(){e(".mpbig-container").addClass("mpbig-loaded")})});