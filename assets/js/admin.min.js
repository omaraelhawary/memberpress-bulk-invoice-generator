jQuery(document).ready(function(e){"use strict";var i={isProcessing:!1,progressInterval:null,currentBatch:0,totalBatches:0};function s(s){var a=e("#mpbig-generate"),o=e("#mpbig-spinner"),t=e("#mpbig-progress"),p=e("#mpbig-results"),r=e("#mpbig-results-content"),d=e("#mpbig-form"),m=e("#mpbig-progress-container");i.isProcessing=!1,n(),r.html('<div class="mpbig-notice mpbig-notice-error"><p>'+s+"</p></div>"),p.removeClass("mpbig-hidden").addClass("mpbig-slide-down mpbig-fade-in"),p[0].offsetHeight,p.addClass("mpbig-visible"),a.prop("disabled",!1).removeClass("mpbig-loading"),o.addClass("mpbig-hidden"),t.addClass("mpbig-hidden"),m.addClass("mpbig-hidden"),d.removeClass("mpbig-loading")}function a(){var o=e("#mpbig-generate"),t=e("#mpbig-spinner"),p=(e("#mpbig-progress-text"),e("#mpbig-results")),r=e("#mpbig-results-content"),d=e("#mpbig-progress-container"),m=e("#mpbig-form"),g=new FormData;g.append("action","mpbig_process_batch"),g.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:g,processData:!1,contentType:!1,success:function(g){if(g.success)if(i.currentBatch++,g.complete){i.isProcessing=!1,n();var c='<div class="mpbig-notice mpbig-notice-success"><p>'+g.message+"</p></div>";g.errors&&g.errors.length>0&&(c+='<div class="mpbig-notice mpbig-notice-warning"><p><strong>Errors:</strong></p><ul>',g.errors.forEach(function(e){c+="<li>"+e+"</li>"}),c+="</ul></div>"),r.html(c),p.removeClass("mpbig-hidden").addClass("mpbig-slide-down mpbig-fade-in"),p[0].offsetHeight,p.addClass("mpbig-visible"),o.prop("disabled",!1).removeClass("mpbig-loading"),t.addClass("mpbig-hidden"),e("#mpbig-progress").addClass("mpbig-hidden"),d.removeClass("mpbig-visible").addClass("mpbig-slide-up"),setTimeout(function(){d.addClass("mpbig-hidden").removeClass("mpbig-slide-down mpbig-slide-up")},400),m.removeClass("mpbig-loading"),g.create_zip&&function(){var i=e("#mpbig-results-content"),s=e("#mpbig-progress-text"),a=e("#mpbig-progress"),n=e("#mpbig-spinner");s.text(mpbig_ajax.creating_zip),a.removeClass("mpbig-hidden"),n.removeClass("mpbig-hidden");var o=new FormData;o.append("action","mpbig_create_zip"),o.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:o,processData:!1,contentType:!1,success:function(e){if(a.addClass("mpbig-hidden"),n.addClass("mpbig-hidden"),e.success){var s='<div class="mpbig-notice mpbig-notice-success"><p>'+e.message+"</p>";s+='<p><a href="'+e.zip_url+'" class="mpbig-download-btn" download="'+e.zip_filename+'">Download ZIP File</a></p></div>',i.append(s)}else s='<div class="mpbig-notice mpbig-notice-error"><p>'+e.message+"</p></div>",i.append(s)},error:function(e,s,o){a.addClass("mpbig-hidden"),n.addClass("mpbig-hidden");var t='<div class="mpbig-notice mpbig-notice-error"><p>'+mpbig_ajax.zip_error+": "+o+"</p></div>";i.append(t)}})}()}else setTimeout(a,100);else i.isProcessing=!1,n(),s(g.message)},error:function(e,a,o){i.isProcessing=!1,n(),s(mpbig_ajax.error+": "+o)}})}function n(){i.progressInterval&&(clearInterval(i.progressInterval),i.progressInterval=null)}function o(i,s){var a=s>0?Math.round(i/s*100):0;e("#mpbig-progress-fill")[0].style.setProperty("--progress-width",a+"%"),e("#mpbig-progress-current").text(i),e("#mpbig-progress-total").text(s),e("#mpbig-progress-percentage").text(a+"%")}e(".mpbig-datepicker").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearRange:"-10:+1",showAnim:"fadeIn"}),e("#mpbig-type").on("change",function(){var i=e(this).val(),s=e("#mpbig-period-options");"period"===i?(s.removeClass("mpbig-hidden").addClass("mpbig-slide-down mpbig-visible mpbig-fade-in"),s[0].offsetHeight,s.addClass("mpbig-visible")):(s.removeClass("mpbig-visible").addClass("mpbig-slide-up"),setTimeout(function(){s.addClass("mpbig-hidden").removeClass("mpbig-slide-down mpbig-slide-up")},300))}),e("#mpbig-form").on("submit",function(t){if(t.preventDefault(),!i.isProcessing){var p=e(this),r=e("#mpbig-generate"),d=e("#mpbig-spinner"),m=e("#mpbig-progress"),g=e("#mpbig-progress-text"),c=e("#mpbig-results"),l=(e("#mpbig-results-content"),e("#mpbig-progress-container"));e(".mpbig-notice-error").remove();var b,u=function(){var i=[];if("period"===e("#mpbig-type").val()){var s=e("#mpbig-start-date").val(),a=e("#mpbig-end-date").val();s&&a?new Date(s)>=new Date(a)&&i.push("End date must be after start date."):i.push("Please select both start and end dates for period generation.")}0===e('input[name="status[]"]:checked').length&&i.push("Please select at least one transaction status.");var n=e("#mpbig-customer-email").val().trim();return n&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)&&i.push("Please enter a valid email address for the customer filter."),i}();if(u.length>0)return b='<div class="mpbig-notice mpbig-notice-error"><p><strong>Please fix the following errors:</strong></p><ul>',u.forEach(function(e){b+="<li>"+e+"</li>"}),b+="</ul></div>",e(".mpbig-notice-error").remove(),e("#mpbig-form").prepend(b),void e("html, body").animate({scrollTop:e(".mpbig-notice-error").offset().top-100},500);i.isProcessing=!1,n(),r.prop("disabled",!0).addClass("mpbig-loading"),d.removeClass("mpbig-hidden"),m.removeClass("mpbig-hidden"),g.text(mpbig_ajax.generating),c.addClass("mpbig-hidden"),l.addClass("mpbig-hidden"),p.addClass("mpbig-loading");var f=new FormData(p[0]);f.append("action","mpbig_generate_invoices"),f.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:f,processData:!1,contentType:!1,success:function(n){n.success?(i.isProcessing=!0,i.totalBatches=Math.ceil(n.total/mpbig_ajax.batch_size),i.currentBatch=0,l.removeClass("mpbig-hidden").addClass("mpbig-slide-down mpbig-fade-in"),l[0].offsetHeight,l.addClass("mpbig-visible"),o(0,n.total),i.progressInterval=setInterval(function(){!function(){var i=new FormData;i.append("action","mpbig_get_progress"),i.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:i,processData:!1,contentType:!1,success:function(i){i.success&&(o(i.processed,i.total),function(i,s,a,n){var o="Processed: "+i+" / "+s+" transactions";a>0&&(o+=" | Successful: "+a),n&&n.length>0&&(o+=" | Errors: "+n.length),e("#mpbig-progress-status").text(o)}(i.processed,i.total,i.successful,i.errors))}})}()},2e3),a()):s(n.message)},error:function(e,i,a){var n=mpbig_ajax.error+": "+a;if(e.responseJSON&&e.responseJSON.data&&e.responseJSON.data.message)n=e.responseJSON.data.message;else if(e.responseText)try{var o=JSON.parse(e.responseText);o.data&&o.data.message&&(n=o.data.message)}catch(e){}s(n)}})}}),e(".mpbig-checkbox-item").on("click",function(){var i=e(this).find('input[type="checkbox"]');i.prop("checked",!i.prop("checked")),e(this).toggleClass("mpbig-checked",i.prop("checked"))});var t=(new Date).getFullYear();e("#mpbig-start-date").val(t+"-01-01"),e("#mpbig-end-date").val(t+"-12-31"),e(".mpbig-card").hover(function(){e(this).addClass("mpbig-hover")},function(){e(this).removeClass("mpbig-hover")}),e(".mpbig-form-control:not(.mpbig-select)").on("focus",function(){e(this).closest(".mpbig-form-group").addClass("mpbig-focused")}).on("blur",function(){e(this).closest(".mpbig-form-group").removeClass("mpbig-focused")}),e("#mpbig-download-files").on("click",function(){var i=e(this),s=e("#mpbig-download-spinner");i.prop("disabled",!0).addClass("mpbig-loading"),s.removeClass("mpbig-hidden");var a=new FormData;a.append("action","mpbig_download_files"),a.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:a,processData:!1,contentType:!1,success:function(a){if(i.prop("disabled",!1).removeClass("mpbig-loading"),s.addClass("mpbig-hidden"),a.success){var n=document.createElement("a");n.href=a.zip_url,n.download=a.zip_filename,document.body.appendChild(n),n.click(),document.body.removeChild(n);var o='<div class="mpbig-notice mpbig-notice-success"><p>'+a.message+" ("+a.file_count+" files)</p></div>";e(".mpbig-file-management").after(o),e("html, body").animate({scrollTop:e(".mpbig-notice-success").offset().top-100},500),setTimeout(function(){e(".mpbig-notice-success").addClass("mpbig-fade-out mpbig-hidden"),setTimeout(function(){e(".mpbig-notice-success").remove()},300)},5e3)}else o='<div class="mpbig-notice mpbig-notice-error"><p>'+a.message+"</p></div>",e(".mpbig-file-management").after(o),e("html, body").animate({scrollTop:e(".mpbig-notice-error").offset().top-100},500)},error:function(a,n,o){i.prop("disabled",!1).removeClass("mpbig-loading"),s.addClass("mpbig-hidden");var t='<div class="mpbig-notice mpbig-notice-error"><p>Error: '+o+"</p></div>";e(".mpbig-file-management").after(t)}})}),e("#mpbig-empty-folder").on("click",function(){if(confirm("Are you sure you want to delete all PDF files? This action cannot be undone.")){var i=e(this),s=e("#mpbig-empty-spinner");i.prop("disabled",!0).addClass("mpbig-loading"),s.removeClass("mpbig-hidden");var a=new FormData;a.append("action","mpbig_empty_folder"),a.append("nonce",mpbig_ajax.nonce),e.ajax({url:mpbig_ajax.ajax_url,type:"POST",data:a,processData:!1,contentType:!1,success:function(a){if(i.prop("disabled",!1).removeClass("mpbig-loading"),s.addClass("mpbig-hidden"),a.success){var n='<div class="mpbig-notice mpbig-notice-success"><p>'+a.message+"</p></div>";e(".mpbig-file-management").after(n),e(".mpbig-file-stat-number").first().text("0"),e(".mpbig-file-stat-number").last().text("0 B"),e("html, body").animate({scrollTop:e(".mpbig-notice-success").offset().top-100},500),setTimeout(function(){e(".mpbig-notice-success").addClass("mpbig-fade-out mpbig-hidden"),setTimeout(function(){e(".mpbig-notice-success").remove()},300)},5e3)}else n='<div class="mpbig-notice mpbig-notice-error"><p>'+a.message+"</p></div>",e(".mpbig-file-management").after(n),e("html, body").animate({scrollTop:e(".mpbig-notice-error").offset().top-100},500)},error:function(a,n,o){i.prop("disabled",!1).removeClass("mpbig-loading"),s.addClass("mpbig-hidden");var t='<div class="mpbig-notice mpbig-notice-error"><p>Error: '+o+"</p></div>";e(".mpbig-file-management").after(t)}})}}),e(window).on("load",function(){e(".mpbig-container").addClass("mpbig-loaded")})});